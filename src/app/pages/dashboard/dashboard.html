<h2>Dashboard</h2>

<p>Statut MQTT: <b>{{ status$ | async }}</b></p>

<ng-container *ngIf="(telemetry$ | async) as t; else noData">
  <ng-container *ngIf="cfg$ | async as cfg">

    <div class="grid">
      <ng-container *ngFor="let w of cfg.widgets">
        <ng-container *ngIf="w.enabled">


             <!-- KPI Battery -->
<mat-card *ngIf="w.type === 'kpi-battery'"
          class="kpi"
          [class.kpi-battery]="(t?.battery ?? 0) >= cfg.alertThresholds.batteryLow"
          [class.kpi-battery-low]="(t?.battery ?? 0) < cfg.alertThresholds.batteryLow">
  <mat-card-content class="kpi-content">
    <div class="kpi-left">
      <div class="kpi-icon">
        <mat-icon>battery_full</mat-icon>
      </div>
      <div>
        <div class="kpi-title">{{ w.title }}</div>
        <div class="kpi-sub">Niveau actuel</div>
      </div>
    </div>

    <div class="kpi-right">
      <div class="kpi-value">{{ fmt(t?.battery, 0) }}%</div>
    </div>
  </mat-card-content>
</mat-card>


          <!-- KPI Temp -->
          <mat-card *ngIf="w.type === 'kpi-temp'" class="kpi kpi-temp">
  <mat-card-content class="kpi-content">
    <div class="kpi-left">
      <div class="kpi-icon">
        <mat-icon>device_thermostat</mat-icon>
      </div>
      <div>
        <div class="kpi-title">{{ w.title }}</div>
        <div class="kpi-sub">Capteur interne</div>
      </div>
    </div>

    <div class="kpi-right">
      <div class="kpi-value">{{ fmt(t?.temp, 1) }}°C</div>
    </div>
  </mat-card-content>
</mat-card>


          <!-- KPI RSSI -->
          <mat-card *ngIf="w.type === 'kpi-rssi'" class="kpi kpi-rssi">
  <mat-card-content class="kpi-content">
    <div class="kpi-left">
      <div class="kpi-icon">
        <mat-icon>network_cell</mat-icon>
      </div>
      <div>
        <div class="kpi-title">{{ w.title }}</div>
        <div class="kpi-sub">Qualité du lien</div>
      </div>
    </div>

    <div class="kpi-right">
      <div class="kpi-value">{{ fmt(t?.rssi, 0) }} dBm</div>
    </div>
  </mat-card-content>
</mat-card>


          <!-- KPI GPS -->
          <mat-card *ngIf="w.type === 'kpi-gps'" class="kpi kpi-gps">
  <mat-card-content class="kpi-content">
    <div class="kpi-left">
      <div class="kpi-icon">
        <mat-icon>my_location</mat-icon>
      </div>
      <div>
        <div class="kpi-title">{{ w.title }}</div>
      </div>
    </div>

    <div class="kpi-right">
      <div class="kpi-value small">{{ fmt(t?.lat, 2) }}, {{ fmt(t?.lng, 2) }}</div>
    </div>
  </mat-card-content>
</mat-card>


          <!-- Carte -->
         <mat-card *ngIf="w.type === 'mini-map'" class="wide map-card">
  <mat-card-title>{{ w.title }}</mat-card-title>
  <mat-card-content class="map-container">
    <app-mini-map
      [lat]="t?.lat"
      [lng]="t?.lng">
    </app-mini-map>

    <p class="hint">Carte miniature : position GPS du drone.</p>
  </mat-card-content>
</mat-card>
          <!-- Graphique -->
         <mat-card *ngIf="w.type === 'chart-telemetry'" class="wide">
  <mat-card-title>{{ w.title }} ({{ cfg.chartType }})</mat-card-title>
  <mat-card-content>
 <app-telemetry-chart
  [chartType]="cfg.chartType"
  [history]="history"
  [point]="t">
</app-telemetry-chart>


  </mat-card-content>
</mat-card>

          <!-- Alertes -->
          <mat-card *ngIf="w.type === 'alerts'" class="wide">
            <mat-card-title>{{ w.title }}</mat-card-title>
            <mat-card-content>
              <div *ngIf="alerts$ | async as a">
                <p *ngIf="a.length === 0" class="hint">Aucune alerte.</p>
                <div *ngFor="let item of a" class="alert" 
                     [class.critical]="item.level === 'critical'" 
                     [class.warn]="item.level === 'warn'">
                  <b>{{ item.level }}</b> — {{ item.message }}
                </div>
              </div>
            </mat-card-content>
          </mat-card>

        </ng-container>
      </ng-container>
    </div>

  </ng-container>
</ng-container>

<ng-template #noData>
  <p>Aucune donnée reçue.</p>
</ng-template>