<!-- =========================
     HEADER (FLOTTE)
========================= -->
<div class="fleet-header">
  <div class="fleet-title">
    <h2>Dashboard</h2>
    <div class="sub">
      <span>Flotte en temps rÃ©el</span>
      <span class="sep">â€¢</span>
      <span>Statut MQTT: <b>{{ status$ | async }}</b></span>
    </div>
  </div>

  <mat-form-field appearance="outline" class="search">
    <mat-label>Rechercher un Ã©quipement</mat-label>
    <input matInput [formControl]="searchCtrl" placeholder="ex: 70B3D57E..." />
    <mat-icon matSuffix>search</mat-icon>
  </mat-form-field>
</div>

<!-- =========================
     LISTE + MAP (UNE SEULE)
========================= -->
<ng-container *ngIf="(filtered$ | async) as devices">
  <mat-card class="fleet-list-card">
    <mat-card-title>Ã‰quipements ({{ devices.length }})</mat-card-title>

    <mat-card-content>
      <div class="equip-list" *ngIf="devices.length > 0; else emptyState">
        <ng-container *ngIf="(selected$ | async) as selected">

          <button
            mat-stroked-button
            class="equip-item"
            *ngFor="let d of devices; trackBy: trackByEui"
            (click)="onSelect(d.device_eui)"
            [class.active]="d.active"
            [class.inactive]="!d.active"
            [class.selected]="d.device_eui === selected"
          >
            <span class="dot"></span>

            <span class="eui">{{ d.device_eui }}</span>

            <span class="meta">
              Bat: {{ fmt(d.last.battery, 0) }}% â€¢
              RSSI: {{ fmt(d.last.rssi, 0) }} â€¢
              vu il y a {{ secondsAgo(d.lastSeenMs) }}
            </span>
          </button>

        </ng-container>
      </div>

      <ng-template #emptyState>
        <div class="hint">
          Aucun Ã©quipement reÃ§u. VÃ©rifie le topic <b>drone/telemetry</b>.
        </div>
      </ng-template>
    </mat-card-content>
  </mat-card>

  <!-- âœ… UNE SEULE CARTE -->
  <mat-card class="map-card fleet-map-card">
    <mat-card-title>Carte flotte</mat-card-title>

    <mat-card-content>
      <ng-container *ngIf="(selected$ | async) as selected">
        <app-fleet-map
  [follow]="false"
  [devices]="devices"
  [selected]="(selected$ | async) ?? null"
  [showHistory]="false"
  (selectDevice)="onSelect($event)"
></app-fleet-map>


        <div class="map-hint">
          ðŸŸ¢ Actif â€¢ ðŸ”´ Inactif â€¢ Clique un marker ou un Ã©quipement pour sÃ©lectionner
        </div>
      </ng-container>
    </mat-card-content>
  </mat-card>
</ng-container>

<!-- =========================
     KPI / CHART / ALERTS
========================= -->
<p>Statut MQTT: <b>{{ status$ | async }}</b></p>

<ng-container *ngIf="(telemetry$ | async) as t; else noData">
  <ng-container *ngIf="cfg$ | async as cfg">

    <div class="grid">
      <ng-container *ngFor="let w of cfg.widgets">
        <ng-container *ngIf="w.enabled">

          <!-- KPI Battery -->
          <mat-card *ngIf="w.type === 'kpi-battery'"
                    class="kpi"
                    [class.kpi-battery]="(t?.battery ?? 0) >= cfg.alertThresholds.batteryLow"
                    [class.kpi-battery-low]="(t?.battery ?? 0) < cfg.alertThresholds.batteryLow">
            <mat-card-content class="kpi-content">
              <div class="kpi-left">
                <div class="kpi-icon">
                  <mat-icon>battery_full</mat-icon>
                </div>
                <div>
                  <div class="kpi-title">{{ w.title }}</div>
                  <div class="kpi-sub">Niveau actuel</div>
                </div>
              </div>

              <div class="kpi-right">
                <div class="kpi-value">{{ fmt(t?.battery, 0) }}%</div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- KPI Temp -->
          <mat-card *ngIf="w.type === 'kpi-temp'" class="kpi kpi-temp">
            <mat-card-content class="kpi-content">
              <div class="kpi-left">
                <div class="kpi-icon">
                  <mat-icon>device_thermostat</mat-icon>
                </div>
                <div>
                  <div class="kpi-title">{{ w.title }}</div>
                  <div class="kpi-sub">Capteur interne</div>
                </div>
              </div>

              <div class="kpi-right">
                <div class="kpi-value">{{ fmt(t?.temp, 1) }}Â°C</div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- KPI RSSI -->
          <mat-card *ngIf="w.type === 'kpi-rssi'" class="kpi kpi-rssi">
            <mat-card-content class="kpi-content">
              <div class="kpi-left">
                <div class="kpi-icon">
                  <mat-icon>network_cell</mat-icon>
                </div>
                <div>
                  <div class="kpi-title">{{ w.title }}</div>
                  <div class="kpi-sub">QualitÃ© du lien</div>
                </div>
              </div>

              <div class="kpi-right">
                <div class="kpi-value">{{ fmt(t?.rssi, 0) }} dBm</div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- KPI GPS -->
          <mat-card *ngIf="w.type === 'kpi-gps'" class="kpi kpi-gps">
            <mat-card-content class="kpi-content">
              <div class="kpi-left">
                <div class="kpi-icon">
                  <mat-icon>my_location</mat-icon>
                </div>
                <div>
                  <div class="kpi-title">{{ w.title }}</div>
                </div>
              </div>

              <div class="kpi-right">
                <div class="kpi-value small">{{ fmt(t?.lat, 2) }}, {{ fmt(t?.lng, 2) }}</div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- âœ… PAS DE MINI-MAP ICI (donc jamais 2 cartes) -->

          <!-- Graphique -->
          <mat-card *ngIf="w.type === 'chart-telemetry'" class="wide">
            <mat-card-title>{{ w.title }} ({{ cfg.chartType }})</mat-card-title>
            <mat-card-content>
              <app-telemetry-chart
                [chartType]="cfg.chartType"
                [history]="history"
                [point]="t">
              </app-telemetry-chart>
            </mat-card-content>
          </mat-card>

          <!-- Alertes -->
          <mat-card *ngIf="w.type === 'alerts'" class="wide">
            <mat-card-title>{{ w.title }}</mat-card-title>
            <mat-card-content>
              <div *ngIf="alerts$ | async as a">
                <p *ngIf="a.length === 0" class="hint">Aucune alerte.</p>

                <div *ngFor="let item of a"
                     class="alert"
                     [class.critical]="item.level === 'critical'"
                     [class.warn]="item.level === 'warn'">
                  <b>{{ item.level }}</b> â€” {{ item.message }}
                </div>
              </div>
            </mat-card-content>
          </mat-card>

        </ng-container>
      </ng-container>
    </div>

  </ng-container>
</ng-container>

<ng-template #noData>
  <p>Aucune donnÃ©e reÃ§ue.</p>
</ng-template>
